<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>

<style>
    table,
    td,
    th {
        border: 1px solid grey;
        border-collapse: collapse;
        padding: auto auto;
    }

    th {
        cursor: pointer;
        background-color: lightgrey;

    }

    .header {
        background-color: white;
        text-align: center;
        padding: 2%;
    }

    .nav {
        background-color: lightgrey;
        float: left;
        width: 15%;
        height: 100%;
        padding: 2%;
    }

    .section {
        background-color: lightgoldenrodyellow;
        width: 79%;
        float: left;
        padding-left: 0.5%;
        overflow: auto;
    }

    .upload {
        text-align: center;
        width: 15%;
        height: 9%;
        font-style: italic;
        font-size: large;
        background-color: lightskyblue;
    }

    #fileUpload {

    }


</style>

<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

<script type="text/javascript">
    var hideColum = [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28,
        29, 30, 31];
    //    var hideColum = [4, 5, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 27, 28];
    var combArr = [6, 7, 8, 9, 14, 24, 25, 26, 29, 30, 31];
    $(function () {
        $("#upload").bind("click", function () {
            var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
            if (regex.test($("#fileUpload").val().toLowerCase())) {
                if (typeof (FileReader) != "undefined") {
                    alert("Success!");
                    var reader = new FileReader();
                    reader.readAsText($("#fileUpload")[0].files[0]);
                    reader.onload = function (e) {
                        var table = $("<table id='tabid'/>");
                        var rows = e.target.result.split("\n");
                        var tHead = $("<thead/>");
                        var theadtr = $("<tr />");
                        var thcells = rows[0].split(",");
                        for (var i = 0; i < thcells.length; i++) {
                            var cell = $("<th />");
                            cell.html(thcells[i]);
                            theadtr.append(cell);
                        }
                        tHead.append(theadtr);
                        table.append(tHead);

                        //start

                        var stuTab = combine(rows, combArr);
                        stuTab.unshift(rows[0].split(","));
                        saveStudent(stuTab);
                        stuTab.shift();
                        var tBody = $("<tbody/>");
                        for (var i = 0; i < stuTab.length; i++) {
                            var row = $("<tr />");
                            var cells = stuTab[i];
                            for (var j = 0; j < cells.length; j++) {
                                var cell = $("<td />");
                                cell.html(cells[j]);
                                row.append(cell);
                            }
                            tBody.append(row);
                        }
                        table.append(tBody);
                        $(".section").html('');
                        $(".section").append(table);
                        hideALL();
                        saveFile(rows);
                    }
//                    reader.readAsText($("#fileUpload")[0].files[0]);
                } else {
                    alert("This browser does not support HTML5.");
                }
            } else {
                alert("Please upload a valid CSV file.");
            }
        });
    });
</script>

<script type="text/javascript">
    function combine(rows, combArr) {
        var stuTab = [];
        for (var i = 1; i < rows.length; i++) {
            var stucells = rows[i].split(",");
            var stuinfo = [];
            for (var j = 0; j < stucells.length; j++) {
                stuinfo.push(stucells[j]);
            }
            var set = true;
            for (j = 0; j < combArr.length; j++) {
                if (combArr[j] != 24 && combArr[j] != 25 && combArr[j] != 26 && combArr[j] != 29 && combArr[j] != 30) {
                    for (var k = 0; k < stuTab.length; k++) {
                        if (stuinfo[0] == stuTab[k][0]) {
                            var term = stuTab[k][combArr[j]].split(",");
                            if (!contains(stuinfo[combArr[j]], term)) {
                                term += ("," + stuinfo[combArr[j]]);
                                stuTab[k][combArr[j]] = term;
                            }
                            set = false;
                        }
                    }
                } else {
                    for (k = 0; k < stuTab.length; k++) {
                        if (stuinfo[0] == stuTab[k][0] && stuinfo[6] > stuTab[k][6]) {
                            term = stuinfo[6];
                            stuTab[k][combArr[j]] = term;
                            set = false;
                        }
                    }
                }
            }
            if (set) {
                stuTab.push(stuinfo);
            }
        }
        return stuTab;
    }

    function contains(value, arr) {
        var i = arr.length;
        while (i--) {
            if (arr[i] == value) {
                return true;
            }
        }
        return false;
    }
</script>

<script type="text/javascript">
    function hideALL() {
        var thead = document.getElementsByTagName('thead');
        var thr = thead[0];

        var j;
        for (j = 0; j < 32; j++) {
            if (hideColum.indexOf(j) >= 0) {
                thr.getElementsByTagName('th')[j].style.display = 'none';
                //thr.getElementsByTagName('th')[j].style.visibility='hidden';
            }
        }

        var tr = document.getElementsByTagName('tr');
        var i;
        for (i = 1; i < tr.length; i++) {
            var j;
            for (j = 0; j < 32; j++) {
                if (hideColum.indexOf(j) >= 0) {
                    tr[i].getElementsByTagName('td')[j].style.display = 'none';
                    //tr[i].getElementsByTagName('td')[j].style.visibility='hidden';
                }
            }

        }
    }
</script>
<script type="text/javascript">
    function saveFile(rows) {
        if (rows != null) {
            var data = [];
            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].split(",");
                var sRow = [];
                for (var j = 0; j < cells.length; j++) {
                    sRow.push(cells[j]);
                }
                data.push(sRow);
            }
            var sent = JSON.stringify(data);
            sessionStorage.setItem("tab", sent);
            alert("File Saved!");
        } else {
            alert("File Empty!")
        }
    }

    function saveStudent(table) {
        var sentTab = JSON.stringify(table);
        sessionStorage.setItem("stuTab", sentTab);
    }
</script>

<body>
<div class="header">
    <input type="file" id="fileUpload"/>
    <input type="button" class="upload" id="upload" value="Upload"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</div>

<div id="div1" class="section"></div>
</body>
</html>