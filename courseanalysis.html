<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="coursecss.css" type="text/css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
          integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M" crossorigin="anonymous">
    <title>Course Analysis</title>
</head>



<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

<script type="text/javascript">
    var hideColum = [3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28,
        29, 30, 31];
    //    var hideColum = [4, 5, 10, 11, 12, 13, 15, 16, 17, 18, 19, 20, 21, 22, 23, 27, 28];
    var combArr = [6, 7, 8, 9, 14, 24, 25, 26, 29, 30, 31];
    var fileNum = 1;
    var tables = [];
    var tablesRows = [];
    var tableRows = [];
    var tableCells = [];
    $(function () {
        $("#upload").bind("click", function () {
            var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.csv|.txt)$/;
            if (regex.test($("#file1").val().toLowerCase())) {
                if (typeof (FileReader) != "undefined") {
                    //alert("Success!");
                    var reader = new FileReader();
                    reader.readAsText($("#file" + fileNum)[0].files[0]);
                    reader.onload = function (e) {
                        var table = $("<table id=fileNum />");
                        var rows = e.target.result.split("\n");
                        var tHead = $("<thead/>");
                        var theadtr = $("<tr />");
                        var thcells = rows[0].split(",");
                        for (var i = 0; i < thcells.length; i++) {
                            var cell = $("<th />");
                            cell.html(thcells[i]);
                            tableCells.push(thcells[i]);
                            theadtr.append(cell);
                        }
                        tHead.append(theadtr);
                        table.append(tHead);
                        tableRows.push(tableCells);
                        tableCells = [];
                        //start
//                        var stuTab = combine(rows, combArr);
//                        stuTab.unshift(rows[0].split(","));
//                        saveStudent(stuTab);
//                        stuTab.shift();
                        var tBody = $("<tbody/>");
                        for (var i = 1; i < rows.length - 1; i++) {
                            var row = $("<tr />");
                            var cells = rows[i].split(",");
                            for (var j = 0; j < cells.length; j++) {
                                var cell = $("<td />");
                                cell.html(cells[j]);
                                tableCells.push(cells[j]);
                                row.append(cell);
                            }
                            tBody.append(row);
                            tableRows.push(tableCells);
                            tableCells = [];
                        }
                        table.append(tBody);
                        alert("Tables length: " + tables.length);
                        //tables.push(table);
                        //tablesRows.push(tableRows);
                        if (!containsTable(tableRows, tablesRows)) {
                            tablesRows.push(tableRows);
                            tableRows = [];
                            tables.push(table);
                            alert("table added!");
                        }else {
                            tableRows = [];
                            alert("File already exist!");
                        }
                        //document.getElementsByTagName('td').style.overflow = "scroll";
                        $("#div1").html('');
                        for (i = 0; i < tables.length; i ++) {
                            $("#div1").append(tables[i]);
                        }
                        //alert(rows);
                        //hideALL();
                        //saveFile(rows);
                    }
//                    reader.readAsText($("#fileUpload")[0].files[0]);
                } else {
                    alert("This browser does not support HTML5.");
                }
            } else {
                alert("Please upload a valid CSV file.");
            }
        });
    });
</script>

<script type="text/javascript">
    function combine(rows, combArr) {
        var stuTab = [];
        for (var i = 1; i < rows.length; i++) {
            var stucells = rows[i].split(",");
            var stuinfo = [];
            for (var j = 0; j < stucells.length; j++) {
                stuinfo.push(stucells[j]);
            }
            var set = true;
            for (j = 0; j < combArr.length; j++) {
                if (combArr[j] != 24 && combArr[j] != 25 && combArr[j] != 26 && combArr[j] != 29 && combArr[j] != 30) {
                    for (var k = 0; k < stuTab.length; k++) {
                        if (stuinfo[0] == stuTab[k][0]) {
                            var term = stuTab[k][combArr[j]].split(",");
                            if (!contains(stuinfo[combArr[j]], term)) {
                                term += ("," + stuinfo[combArr[j]]);
                                stuTab[k][combArr[j]] = term;
                            }
                            set = false;
                        }
                    }
                } else {
                    for (k = 0; k < stuTab.length; k++) {
                        if (stuinfo[0] == stuTab[k][0] && stuinfo[6] > stuTab[k][6]) {
                            term = stuinfo[6];
                            stuTab[k][combArr[j]] = term;
                            set = false;
                        }
                    }
                }
            }
            if (set) {
                stuTab.push(stuinfo);
            }
        }
        return stuTab;
    }
    function contains(value, arr) {
        for (var i = 0; i < arr.length; i ++){
            if (value == arr[i]){
                return true;
            }
        }
        return false;
    }
    function containsTable(table, tables) {
        var result = true;
        var file_not_equal = 0;
        if (tables.length == 0){
            return false;
        }
        for (var i = 0; i < tables.length; i ++){
            result = true;
            for (var j = 0; j < table.length; j ++){
                if (table[j].toString() == tables[i][j].toString()){
                    continue;
                }else {
                    result = false;
                    break;
                }
            }
            if (!result){
                file_not_equal ++;
            }
        }
        if (file_not_equal == tables.length){
            return false;
        }else {
            return true;
        }
    }
</script>

<script type="text/javascript">
    function hideALL() {
        var thead = document.getElementsByTagName('thead');
        var thr = thead[0];
        var j;
        for (j = 0; j < 32; j++) {
            if (hideColum.indexOf(j) >= 0) {
                thr.getElementsByTagName('th')[j].style.display = 'none';
                //thr.getElementsByTagName('th')[j].style.visibility='hidden';
            }
        }
        var tr = document.getElementsByTagName('tr');
        var i;
        for (i = 1; i < tr.length; i++) {
            var j;
            for (j = 0; j < 32; j++) {
                if (hideColum.indexOf(j) >= 0) {
                    tr[i].getElementsByTagName('td')[j].style.display = 'none';
                    //tr[i].getElementsByTagName('td')[j].style.visibility='hidden';
                }
            }
        }
    }
</script>
<script type="text/javascript">
    function saveFile(rows) {
        if (rows != null) {
            var data = [];
            for (var i = 0; i < rows.length; i++) {
                var cells = rows[i].split(",");
                var sRow = [];
                for (var j = 0; j < cells.length; j++) {
                    sRow.push(cells[j]);
                }
                data.push(sRow);
            }
            var sent = JSON.stringify(data);
            sessionStorage.setItem("tab", sent);
            //alert("File Saved!");
        } else {
            alert("File Empty!")
        }
    }
    function saveStudent(table) {
        var sentTab = JSON.stringify(table);
        sessionStorage.setItem("stuTab", sentTab);
    }
</script>
<script type="text/javascript">
    function addFile() {
        fileNum += 1;
        var section = document.getElementById("uploadFile");
        var br1 = document.createElement("br");
        var br2 = document.createElement("br");
        var fileUp = document.createElement("input");
//        var button1 = document.createElement("input");
//        button1.setAttribute("type", "button");
//        button1.setAttribute("id", "upload" + fileNum);
//        button1.setAttribute("class", "upload");
//        button1.setAttribute("value", "Upload");
        var button2 = document.createElement("input");
        button2.setAttribute("type", "button");
        button2.setAttribute("class", "upload");
        button2.setAttribute("value", "add");
        //button2.style.marginLeft = "35px";
        fileUp.setAttribute("type", "file");
        fileUp.setAttribute("id", "file" + fileNum);
        alert(fileUp.id);
        section.appendChild(br1);
        section.appendChild(br2);
        section.appendChild(fileUp);
        //section.appendChild(button1);
        //section.appendChild(button2);
    }
</script>
<body>

<header> RMIT - Learning Analytics </header>

<main>
<div id="uploadFile" class="upload">
    <input type="file" id="file1"/>
    <input type="button" class="upload" id="upload" value="Upload"/>
    <input type="button" class="upload" id="add" value="add" onclick="addFile()">
</div>

<div id="div1" class="table1"></div>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
        integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"
        integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1" crossorigin="anonymous"></script>

</main>
<footer>
    <p>RMIT - COSC2616 Software Engineering Postgraduate Project - 2017, Sem 2<br>
        &copy 2017 <a href="mailto:nebojsa.pajkic@rmit.edu.au">Learning Analytics Team</a></p>
</footer>
</body>
</html>